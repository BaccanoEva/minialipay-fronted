{"ast":null,"code":"import _regeneratorRuntime from \"/Users/hotpotman/Desktop/minialipay/minialipay-frontend/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/hotpotman/Desktop/minialipay/minialipay-frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nvar _jsxFileName = \"/Users/hotpotman/Desktop/minialipay/minialipay-frontend/src/util/showPage.js\";\nimport * as React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport showConfirmModal from \"./showConfirmModal\";\nvar pageStack = [];\nexport function getPageStack() {\n  return pageStack;\n}\nvar lockLevel = 0;\nexport function lockBackButton() {\n  lockLevel++;\n}\nexport function unlockBackButton() {\n  lockLevel--;\n}\n\nfunction doBackButton() {\n  return _doBackButton.apply(this, arguments);\n}\n\nfunction _doBackButton() {\n  _doBackButton = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee() {\n    var page;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!(lockLevel > 0)) {\n              _context.next = 2;\n              break;\n            }\n\n            return _context.abrupt(\"return\");\n\n          case 2:\n            if (pageStack.length) {\n              _context.next = 8;\n              break;\n            }\n\n            _context.next = 5;\n            return showConfirmModal({\n              message: \"是否退出本APP？\"\n            });\n\n          case 5:\n            if (!_context.sent) {\n              _context.next = 7;\n              break;\n            }\n\n            navigator.app.exitApp();\n\n          case 7:\n            return _context.abrupt(\"return\");\n\n          case 8:\n            page = pageStack[pageStack.length - 1];\n\n            if (!page.onLeftClick) {\n              if (page.refs && page.refs.wrappedComponent && page.refs.wrappedComponent.onLeftClick) {\n                page.refs.wrappedComponent.onLeftClick();\n                pageStack.pop();\n              } else {\n                console.warn(\"找不到关闭Page的方法：\", page);\n              }\n            } else {\n              page.onLeftClick();\n              pageStack.pop();\n            }\n\n          case 10:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, this);\n  }));\n  return _doBackButton.apply(this, arguments);\n}\n\ndocument.addEventListener(\"backbutton\", doBackButton, false);\nwindow.doBackButton = doBackButton;\nvar modalDomRefStack = []; // 以 Promise 的方法子页面\n\nexport default function showPage(modalClass, props, options) {\n  var divRef = document.createElement(\"div\");\n  divRef.className = \"page-wrapper\";\n\n  if (options && options.wrapperClass) {\n    divRef.className += \" \" + options.wrapperClass;\n  }\n\n  document.body.appendChild(divRef); // append dom ref\n\n  if (modalDomRefStack.indexOf(divRef) < 0) {\n    modalDomRefStack.push(divRef);\n  }\n\n  var ModalClass = modalClass;\n  var modalRef = null;\n\n  var clearUp = function clearUp() {\n    ReactDOM.unmountComponentAtNode(divRef);\n\n    try {\n      document.body.removeChild(divRef);\n    } catch (e) {\n      console.warn(e);\n    } // remove react virtual ref\n\n\n    if (pageStack.indexOf(modalRef) >= 0) {\n      pageStack.splice(pageStack.indexOf(modalRef), 1);\n    } // remove dom ref\n\n\n    if (modalDomRefStack.indexOf(divRef) >= 0) {\n      modalDomRefStack.splice(modalDomRefStack.indexOf(divRef), 1);\n    }\n  };\n\n  return new Promise(function (resolve) {\n    ReactDOM.render(React.createElement(ModalClass, Object.assign({}, props, {\n      close: function close(data) {\n        var clearUpDelay = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n        resolve(data);\n        setTimeout(function () {\n          clearUp();\n        }, clearUpDelay);\n      },\n      ref: function ref(_ref) {\n        if (_ref) {\n          modalRef = _ref; // append react virtual ref\n\n          if (pageStack.indexOf(_ref) < 0) {\n            pageStack.push(_ref);\n          }\n        }\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 88\n      },\n      __self: this\n    })), divRef);\n  });\n}","map":{"version":3,"sources":["/Users/hotpotman/Desktop/minialipay/minialipay-frontend/src/util/showPage.js"],"names":["React","ReactDOM","showConfirmModal","pageStack","getPageStack","lockLevel","lockBackButton","unlockBackButton","doBackButton","length","message","navigator","app","exitApp","page","onLeftClick","refs","wrappedComponent","pop","console","warn","document","addEventListener","window","modalDomRefStack","showPage","modalClass","props","options","divRef","createElement","className","wrapperClass","body","appendChild","indexOf","push","ModalClass","modalRef","clearUp","unmountComponentAtNode","removeChild","e","splice","Promise","resolve","render","data","clearUpDelay","setTimeout","ref"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport showConfirmModal from \"./showConfirmModal\";\n\nlet pageStack = [];\n\nexport function getPageStack() {\n  return pageStack;\n}\n\nlet lockLevel = 0;\n\nexport function lockBackButton() {\n  lockLevel++;\n}\n\nexport function unlockBackButton() {\n  lockLevel--;\n}\n\nasync function doBackButton() {\n  if (lockLevel > 0) {\n    return;\n  }\n  if (!pageStack.length) {\n    if (await showConfirmModal({message: \"是否退出本APP？\"})) {\n      navigator.app.exitApp();\n    }\n    return;\n  }\n\n  let page = pageStack[pageStack.length - 1];\n\n  if (!page.onLeftClick) {\n    if (page.refs && page.refs.wrappedComponent && page.refs.wrappedComponent.onLeftClick) {\n      page.refs.wrappedComponent.onLeftClick();\n      pageStack.pop();\n    } else {\n      console.warn(\"找不到关闭Page的方法：\", page);\n    }\n  } else {\n    page.onLeftClick();\n    pageStack.pop();\n  }\n}\n\ndocument.addEventListener(\"backbutton\", doBackButton, false);\nwindow.doBackButton = doBackButton;\n\nlet modalDomRefStack = [];\n\n// 以 Promise 的方法子页面\nexport default function showPage(modalClass, props, options) {\n  let divRef = document.createElement(\"div\");\n  divRef.className = \"page-wrapper\";\n\n  if (options && options.wrapperClass) {\n    divRef.className += \" \" + options.wrapperClass;\n  }\n\n  document.body.appendChild(divRef);\n  // append dom ref\n  if (modalDomRefStack.indexOf(divRef) < 0) {\n    modalDomRefStack.push(divRef);\n  }\n  const ModalClass = modalClass;\n  let modalRef = null;\n\n  const clearUp = () => {\n    ReactDOM.unmountComponentAtNode(divRef);\n    try {\n      document.body.removeChild(divRef);\n    } catch (e) {\n      console.warn(e);\n    }\n    // remove react virtual ref\n    if (pageStack.indexOf(modalRef) >= 0) {\n      pageStack.splice(pageStack.indexOf(modalRef), 1);\n    }\n    // remove dom ref\n    if (modalDomRefStack.indexOf(divRef) >= 0) {\n      modalDomRefStack.splice(modalDomRefStack.indexOf(divRef), 1);\n    }\n  };\n\n  return new Promise((resolve) => {\n    ReactDOM.render(\n      <ModalClass\n        {...props}\n        close={(data, clearUpDelay = 0) => {\n          resolve(data);\n          setTimeout(() => {\n            clearUp();\n          }, clearUpDelay);\n        }}\n        ref={ref => {\n          if (ref) {\n            modalRef = ref;\n            // append react virtual ref\n            if (pageStack.indexOf(ref) < 0) {\n              pageStack.push(ref);\n            }\n          }\n        }}\n      />, divRef);\n  });\n}"]},"metadata":{},"sourceType":"module"}